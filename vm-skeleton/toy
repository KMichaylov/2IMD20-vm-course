#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

PROGRAM_ARGS=()
JAVA_ARGS=()
if [ -d "$JAVA_HOME/lib/graalvm" ]; then

    for opt in "$@"
    do
      case $opt in
        -debug)
            JAVA_ARGS+=("-Xdebug" "-Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y") ;;
        -dump)
            JAVA_ARGS+=("-Dpolyglot.engine.AllowExperimentalOptions=true" "-Dgraal.PrintGraph=Network" "-Dgraal.Dump=Truffle:1" "-Dpolyglot.engine.BackgroundCompilation=false" "-Dpolyglot.engine.TraceCompilation=true" "-Dpolyglot.engine.TraceCompilationDetails=true") ;;
        -disassemble)
            JAVA_ARGS+=("-Dpolyglot.engine.AllowExperimentalOptions=true" "-XX:CompileCommand=print,*.*" "-XX:CompileCommand=exclude,*OptimizedCallTarget.profiledPERoot" "-Dpolyglot.engine.BackgroundCompilation=false" "-Dpolyglot.engine.TraceCompilation=true" "-Dpolyglot.engine.TraceCompilationDetails=true") ;;
        -J*)
            opt=${opt:2}
            JAVA_ARGS+=("$opt") ;;
        *)
            PROGRAM_ARGS+=("$opt") ;;
      esac
    done
else
    echo "Warning: Could not find GraalVM on $JAVA_HOME. Running on JDK without support for compilation."
    echo

    for opt in "$@"
    do
      case $opt in
        -debug)
            JAVA_ARGS+=("-Xdebug" "-Xrunjdwp:transport=dt_socket,server=y,address=8000,suspend=y") ;;
        -dump)
            echo "NOTE: Ignoring -dump, only supported on GraalVM." ;;
        -disassemble)
            echo "NOTE: Ignoring -disassemble" ;;
        -J*)
            opt=${opt:2}
            JAVA_ARGS+=("$opt") ;;
        *)
            PROGRAM_ARGS+=("$opt") ;;
      esac
    done
fi

"$JAVA_HOME/bin/java" "${JAVA_ARGS[@]}" -jar "${DIR}/target/vm-1.0-SNAPSHOT.jar" "${PROGRAM_ARGS[@]}"

#"$JAVA_HOME/bin/java" "${JAVA_ARGS[@]}" -jar "${DIR}/target/vm-1.0-SNAPSHOT.jar" nl.tue.vmcourse.toy.ToyLauncher "${PROGRAM_ARGS[@]}"
#"$JAVA_HOME/bin/java" "${JAVA_ARGS[@]}" --module-path "${DIR}/target/vm-1.0-SNAPSHOT.jar" -m nl.tue.vmcourse.toy/nl.tue.vmcourse.toy.ToyLauncher "${PROGRAM_ARGS[@]}"
#"$JAVA_HOME/bin/java" "${JAVA_ARGS[@]}" -p "${DIR}/modules" -m ToyLauncher "${PROGRAM_ARGS[@]}"